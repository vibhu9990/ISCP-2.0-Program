import pandas as pd
import json
import re

# Helper functions for masking
def mask_phone(phone):
    digits = re.sub(r"\D", "", phone)
    if len(digits) >= 10:
        return digits[:2] + "XXXXXX" + digits[-2:]
    return "X" * len(digits)

def mask_email(email):
    try:
        user, domain = email.split("@")
        return user[:2] + "XXX@" + domain
    except:
        return "X" * len(email)

def mask_name(name):
    parts = name.split()
    masked_parts = []
    for p in parts:
        if len(p) > 2:
            masked_parts.append(p[0] + "XXX" + p[-1])
        else:
            masked_parts.append("X")
    return " ".join(masked_parts)

def redact_json(data):
    is_pii = False
    try:
        parsed = json.loads(data.replace("'", '"'))
    except:
        return data, False

    for key, value in parsed.items():
        if isinstance(value, str):
            if re.fullmatch(r"[6-9]\d{9}", value):  # Phone numbers
                parsed[key] = mask_phone(value)
                is_pii = True
            elif "@" in value:  # Email addresses
                parsed[key] = mask_email(value)
                is_pii = True
            elif re.fullmatch(r"[A-Za-z ]{3,}", value):  # Names
                parsed[key] = mask_name(value)
                is_pii = True
        elif isinstance(value, (int, float)) and len(str(value)) == 12:  # Aadhaar-like
            parsed[key] = str(value)[:4] + "XXXX" + str(value)[-4:]
            is_pii = True

    return json.dumps(parsed), is_pii

def main():
    # Load dataset
    df = pd.read_csv("iscp_pii_dataset_-_Sheet1.csv")

    output_rows = []
    for idx, row in df.iterrows():
        record_id = row.get("record_id", idx + 1)
        redacted_json, is_pii = redact_json(str(row["data_json"]))
        output_rows.append({
            "record_id": record_id,
            "redacted_data_json": redacted_json,
            "is_pii": is_pii
        })

    # Save output
    output_df = pd.DataFrame(output_rows)
    output_df.to_csv("redacted_output_candidate_full_name.csv", index=False)
    print("âœ… Redacted CSV generated: redacted_output_candidate_full_name.csv")

if __name__ == "__main__":
    main()
